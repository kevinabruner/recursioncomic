- name: Create Production Template from Dev VM 
  hosts: proxmox
  vars_files:
    - vars.yaml
    - vault.yaml

  tasks:
    - name: Check if the Dev VM is registered on THIS node
      shell: "qm config {{ hostvars[target_vm]['proxmox_vmid'] }}"
      register: vm_on_node
      failed_when: false
      changed_when: false

    - name: Set facts and skip if VM is not here
      set_fact:
        is_source_node: "{{ vm_on_node.rc == 0 }}"

    - name: Template Creation Process
      when: is_source_node
      block:
        - name: Create local shortcuts for VM variables
          set_fact:
            vm_id: "{{ hostvars[target_vm]['proxmox_vmid'] }}"
            template_vmid: "{{ hostvars[target_vm]['proxmox_vmid'] }}0"

        - name: Check if old template exists ON PVE
          shell: "qm status {{ template_vmid }}"
          delegate_to: pve  
          register: template_check
          failed_when: false
          changed_when: false

        - name: Destroy old template ON PVE
          shell: "qm destroy {{ template_vmid }} --purge"
          delegate_to: pve  
          when: template_check.rc == 0
          become: true
          async: 60    
          poll: 5      

        - name: Clone Dev VM
          become: true
          shell: >
            qm clone {{ vm_id }} {{ template_vmid }} 
            --full 
            --name {{ APPLICATION }}-golden 
            --storage truenas-nfs 
            --target pve

- name: Manipulate clone
  hosts: pve
  vars_files:
    - vars.yaml
    - vault.yaml

  tasks:
    - name: Install python3-proxmoxer via apt
      apt:
        name: python3-proxmoxer
        state: present
        update_cache: yes
        
    - name: Create local shortcuts for VM variables
      set_fact:
        vm_id: "{{ hostvars[target_vm]['proxmox_vmid'] }}"
        vm_app: "{{ APPLICATION }}" 
        template_name: "{{ APPLICATION }}-golden"
        template_vmid: "{{ hostvars[target_vm]['proxmox_vmid'] }}0"

    - name: Ensure Guest Agent is enabled on clone
      shell: "qm set {{ template_vmid }} --agent 1"

    - name: Start the cloned VM
      community.general.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        api_host: "{{ inventory_hostname }}"
        vmid: "{{ template_vmid }}"
        state: started
    
    - name: Wait for Guest Agent to respond
      shell: "qm guest exec {{ template_vmid }} -- /bin/sh -c uptime"
      register: agent_ready
      until: agent_ready.rc == 0
      retries: 20
      delay: 10

    - name: Sanitize via Guest Agent
      shell: "qm guest exec {{ template_vmid }} -- /bin/sh -c '{{ item }}'"
      loop:
        - "cloud-init clean --logs"
        - "truncate -s 0 /etc/machine-id"
        - "rm -f /etc/ssh/ssh_host_*"

    - name: Shutdown the clone
      community.general.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        api_host: "{{ inventory_hostname }}"
        vmid: "{{ template_vmid }}"
        state: stopped
        timeout: 300  

    - name: Wait for VM to reach stopped state
      shell: "qm status {{ template_vmid }}"
      register: vm_status
      until: "'stopped' in vm_status.stdout"
      retries: 12
      delay: 5  

    - name: Finalize conversion to Template
      shell: "qm template {{ template_vmid }}"
